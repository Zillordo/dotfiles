#!/usr/bin/env bash
set -euo pipefail

# Interactive Snapper rollback script with fzf
# Usage: rollback [config]
CONFIG="${1:-root}"

echo "Interactive Snapper Rollback - Config: $CONFIG"

# Get snapshots with specific columns for better performance
full_snapper_list=$(sudo snapper -c "$CONFIG" list --columns number,type,date,user,description 2>/dev/null)

# FZF args inspired by mise-plugins-add.sh
fzf_args=(
  --reverse
  --prompt 'rollback> '
  --delimiter '‚îÇ'
  --with-nth '3,5'
  --preview "echo 'üìã Snapshot Details'; echo '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ'; snapshot_num=\$(echo '{}' | awk -F '‚îÇ' '{gsub(/^ *| *\$/, \"\", \$1); print \$1}'); snapshot_type=\$(echo '{}' | awk -F '‚îÇ' '{gsub(/^ *| *\$/, \"\", \$2); print \$2}'); snapshot_date=\$(echo '{}' | awk -F '‚îÇ' '{gsub(/^ *| *\$/, \"\", \$3); print \$3}'); snapshot_user=\$(echo '{}' | awk -F '‚îÇ' '{gsub(/^ *| *\$/, \"\", \$4); print \$4}'); snapshot_desc=\$(echo '{}' | awk -F '‚îÇ' '{gsub(/^ *| *\$/, \"\", \$5); print \$5}'); echo \"Snapshot: \$snapshot_num\"; echo \"Type: \$snapshot_type\"; echo \"Date: \$snapshot_date\"; echo \"User: \$snapshot_user\"; echo \"Description: \$snapshot_desc\"; echo; echo 'üîÑ Changed files:'; sudo snapper -c $CONFIG status \$snapshot_num 2>/dev/null | head -15 || echo 'No diff data available'"
  --preview-window 'down:65%:wrap'
  --bind 'alt-p:toggle-preview'
  --bind 'alt-d:preview-half-page-down,alt-u:preview-half-page-up'
  --bind 'alt-k:preview-up,alt-j:preview-down'
)

# Extract snapshots (skip header) - simple format like before
snapshots=$(echo "$full_snapper_list" | sed '1,3d')

selected=$(echo "$snapshots" | fzf "${fzf_args[@]}")

# Check if user cancelled
if [[ -z "$selected" ]]; then
  echo "‚ùå Rollback cancelled."
  exit 0
fi

# Extract snapshot number (first field)
snapshot_number=$(echo "$selected" | awk '{print $1}')

# Validate snapshot number
if ! [[ "$snapshot_number" =~ ^[0-9]+$ ]]; then
  echo "‚ùå Invalid selection. Please select a valid snapshot."
  exit 1
fi

# Validate snapshot exists (using cached data)
if ! echo "$full_snapper_list" | grep -q "^[[:space:]]*${snapshot_number}[[:space:]]"; then
  echo "‚ùå Snapshot $snapshot_number not found."
  exit 1
fi

# Get snapshot details for confirmation (using cached data)
snapshot_info=$(echo "$full_snapper_list" | grep "^[[:space:]]*${snapshot_number}[[:space:]]")

echo
echo "üéØ Selected snapshot:"
echo "   Number: $snapshot_number"
echo "   Details: $snapshot_info"
echo

# Confirmation prompt
read -p "‚ö†Ô∏è  Are you sure you want to rollback to snapshot $snapshot_number? This will reboot your system! [y/N]: " -r
echo

if [[ ! $REPLY =~ ^[Yy]$ ]]; then
  echo "‚ùå Rollback cancelled."
  exit 0
fi

echo "üîÑ Rolling back to snapshot $snapshot_number..."

# Perform rollback
if sudo snapper -c "$CONFIG" rollback "$snapshot_number"; then
  echo "‚úÖ Rollback completed successfully!"
  echo "üîÑ System will reboot in 5 seconds..."
  echo "   Press Ctrl+C to cancel reboot"

  # Countdown
  for i in {5..1}; do
    echo "   Rebooting in $i..."
    sleep 1
  done

  echo "üîÑ Rebooting now..."
  sudo reboot
else
  echo "‚ùå Rollback failed!"
  exit 1
fi
