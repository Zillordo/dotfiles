#!/usr/bin/env bash
set -euo pipefail

# Manual package list updater (for when you want to refresh manually)
PACKAGES_DIR="$HOME/.config/install"

echo "ðŸ”„ Manually updating package lists..."

# Create directory if it doesn't exist
mkdir -p "$PACKAGES_DIR"

# Generate package lists using pacman (no root warnings, more reliable)
echo "Using pacman for package detection..."
pacman -Qqe >"$PACKAGES_DIR/packages-explicit.txt"
pacman -Qqm >"$PACKAGES_DIR/packages-aur.txt"
pacman -Qqd >"$PACKAGES_DIR/packages-deps.txt"

# Add timestamp
echo "# Manually updated: $(date)" >"$PACKAGES_DIR/last-updated.txt"

# Re-add the updated files to chezmoi to keep the repository in sync
if command -v chezmoi >/dev/null 2>&1; then
  echo "ðŸ”„ Syncing changes to chezmoi..."
  chezmoi re-add "$PACKAGES_DIR/packages-explicit.txt" \
    "$PACKAGES_DIR/packages-aur.txt" \
    "$PACKAGES_DIR/packages-deps.txt" \
    "$PACKAGES_DIR/last-updated.txt" 2>/dev/null || true
fi

echo "âœ… Package lists updated:"
echo "   - Explicit packages: $(wc -l <"$PACKAGES_DIR/packages-explicit.txt")"
echo "   - AUR packages: $(wc -l <"$PACKAGES_DIR/packages-aur.txt")"
echo "   - Dependencies: $(wc -l <"$PACKAGES_DIR/packages-deps.txt")"

# If we're in a git repo, show changes
if git -C "$PACKAGES_DIR" rev-parse --git-dir >/dev/null 2>&1; then
  echo ""
  echo "ðŸ“‹ Changes detected:"
  git -C "$PACKAGES_DIR" diff --name-only packages-*.txt | head -5 || echo "   No changes"
fi
